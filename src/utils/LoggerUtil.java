package utils;

import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.io.PrintWriter;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;

/**
 * Ğ£Ñ‚Ğ¸Ğ»Ğ¸Ñ‚Ğ° Ğ´Ğ»Ñ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ğ¸ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ñ… ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹
 */
public class LoggerUtil {

    private static final String LOG_FILE = "carhub_logs.txt";
    private static final DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss");
    private static boolean sessionActive = false;
    private static String currentSessionUser = null;

    // Ğ¡Ñ‚Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ±Ğ»Ğ¾Ğº Ğ´Ğ»Ñ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ
    static {
        Runtime.getRuntime().addShutdownHook(new Thread(() -> {
            if (sessionActive && currentSessionUser != null) {
                logSessionEnd(currentSessionUser, "ĞŸÑ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¾ Ğ±ĞµĞ· Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ°");
            }
            logSystemEvent("ĞŸÑ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¾");
            writeSeparator();
        }));
    }

    /**
     * Ğ¢Ğ¸Ğ¿Ñ‹ Ğ»Ğ¾Ğ³Ğ¾Ğ²
     */
    public enum LogLevel {
        INFO("â„¹ï¸ INFO"),
        WARNING("âš ï¸ WARNING"),
        ERROR("âŒ ERROR"),
        SUCCESS("âœ… SUCCESS"),
        AUTH("ğŸ” AUTH"),
        ACTION("ğŸ¯ ACTION");

        private final String label;

        LogLevel(String label) {
            this.label = label;
        }

        public String getLabel() {
            return label;
        }
    }

    /**
     * ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
     */
    private static void log(LogLevel level, String message) {
        String timestamp = LocalDateTime.now().format(formatter);
        String logEntry = String.format("[%s] %s: %s%n", timestamp, level.getLabel(), message);

        // Ğ’Ñ‹Ğ²Ğ¾Ğ´ Ğ² ĞºĞ¾Ğ½ÑĞ¾Ğ»ÑŒ
        System.out.print(logEntry);

        // Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ Ğ² Ñ„Ğ°Ğ¹Ğ»
        writeToFile(logEntry);
    }

    /**
     * Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ Ğ² Ñ„Ğ°Ğ¹Ğ» Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾Ğ¹ ĞºĞ¾Ğ´Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¾Ğ¹ UTF-8
     */
    private static void writeToFile(String logEntry) {
        try (FileWriter fw = new FileWriter(LOG_FILE, java.nio.charset.StandardCharsets.UTF_8, true);
             PrintWriter pw = new PrintWriter(fw)) {
            pw.print(logEntry);
        } catch (IOException e) {
            System.err.println("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ² Ğ»Ğ¾Ğ³-Ñ„Ğ°Ğ¹Ğ»: " + e.getMessage());
        }
    }

    // ========== ĞŸĞ£Ğ‘Ğ›Ğ˜Ğ§ĞĞ«Ğ• ĞœĞ•Ğ¢ĞĞ”Ğ« ==========

    /**
     * Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
     */
    public static void info(String message) {
        log(LogLevel.INFO, message);
    }

    /**
     * ĞŸÑ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ğµ
     */
    public static void warning(String message) {
        log(LogLevel.WARNING, message);
    }

    /**
     * ĞŸÑ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ğµ (ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¸Ğ¹ Ğ°Ğ»Ğ¸Ğ°Ñ)
     */
    public static void warn(String message) {
        warning(message);
    }

    /**
     * ĞÑˆĞ¸Ğ±ĞºĞ°
     */
    public static void error(String message, Exception e) {
        String fullMessage = message + " | ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°: " + (e != null ? e.getMessage() : "ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°");
        log(LogLevel.ERROR, fullMessage);
    }

    /**
     * Ğ£ÑĞ¿ĞµÑˆĞ½Ğ°Ñ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ñ
     */
    public static void success(String message) {
        log(LogLevel.SUCCESS, message);
    }

    /**
     * ĞÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ (Ğ²Ñ…Ğ¾Ğ´/Ğ²Ñ‹Ñ…Ğ¾Ğ´)
     */
    public static void auth(String message) {
        log(LogLevel.AUTH, message);
    }

    /**
     * Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
     */
    public static void action(String message) {
        log(LogLevel.ACTION, message);
    }

    // ========== Ğ¡ĞŸĞ•Ğ¦Ğ˜ĞĞ›Ğ¬ĞĞ«Ğ• ĞœĞ•Ğ¢ĞĞ”Ğ« ==========

    /**
     * Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ²Ñ…Ğ¾Ğ´Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
     */
    public static void logLogin(String username, String role) {
        if (!sessionActive) {
            writeSeparator();
            logSystemEvent("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
            logSystemEvent("â•‘          ĞĞĞ’ĞĞ¯ Ğ¡Ğ•Ğ¡Ğ¡Ğ˜Ğ¯ ĞŸĞĞ›Ğ¬Ğ—ĞĞ’ĞĞ¢Ğ•Ğ›Ğ¯                       â•‘");
            logSystemEvent("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
            sessionActive = true;
        }
        currentSessionUser = username;
        auth(String.format("ğŸ‘¤ Ğ’Ñ…Ğ¾Ğ´: Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ '%s' (Ñ€Ğ¾Ğ»ÑŒ: %s)", username, role));
    }

    /**
     * Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
     */
    public static void logLogout(String username) {
        auth(String.format("ğŸ‘‹ Ğ’Ñ‹Ñ…Ğ¾Ğ´: Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ '%s'", username));
        logSessionEnd(username, "ĞĞ¾Ñ€Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ²Ñ‹Ñ…Ğ¾Ğ´");
    }

    /**
     * Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ğµ ÑĞµÑÑĞ¸Ğ¸
     */
    private static void logSessionEnd(String username, String reason) {
        if (sessionActive) {
            info("ğŸ“Š Ğ¡ĞµÑÑĞ¸Ñ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°: " + reason);
            logSystemEvent("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
            logSystemEvent("â•‘          ĞšĞĞĞ•Ğ¦ Ğ¡Ğ•Ğ¡Ğ¡Ğ˜Ğ˜: " + username);
            logSystemEvent("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
            sessionActive = false;
            currentSessionUser = null;
        }
    }

    /**
     * Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ½Ğ¾Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ (Ğ±ĞµĞ· Ñ‚Ğ¸Ğ¿Ğ° Ğ»Ğ¾Ğ³Ğ°)
     */
    private static void logSystemEvent(String message) {
        String timestamp = LocalDateTime.now().format(formatter);
        String logEntry = String.format("[%s] %s%n", timestamp, message);
        System.out.print(logEntry);
        writeToFile(logEntry);
    }

    /**
     * Ğ Ğ°Ğ·Ğ´ĞµĞ»Ğ¸Ñ‚ĞµĞ»ÑŒ Ğ¼ĞµĞ¶Ğ´Ñƒ ÑĞµÑÑĞ¸ÑĞ¼Ğ¸
     */
    private static void writeSeparator() {
        String separator = "\n" + "=".repeat(80) + "\n";
        writeToFile(separator);
    }

    /**
     * Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸
     */
    public static void logRegistration(String username) {
        auth(String.format("Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ: '%s'", username));
    }

    /**
     * Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ°Ğ²Ñ‚Ğ¾
     */
    public static void logCarAdded(String carName, String username) {
        action(String.format("Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒ '%s' Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼ '%s'", carName, username));
    }

    /**
     * Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ°Ğ²Ñ‚Ğ¾
     */
    public static void logCarEdited(String carName, String username) {
        action(String.format("Ğ˜Ğ·Ğ¼ĞµĞ½Ñ‘Ğ½ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒ '%s' Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼ '%s'", carName, username));
    }

    /**
     * Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ Ğ°Ğ²Ñ‚Ğ¾
     */
    public static void logCarDeleted(String carName, String username) {
        action(String.format("Ğ£Ğ´Ğ°Ğ»Ñ‘Ğ½ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒ '%s' Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼ '%s'", carName, username));
    }

    /**
     * Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ°
     */
    public static void logExport(String username, int recordCount) {
        action(String.format("Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…: %d Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹, Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ '%s'", recordCount, username));
    }

    /**
     * ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° ÑÑ‚Ğ°Ñ€Ñ‹Ñ… Ğ»Ğ¾Ğ³Ğ¾Ğ² (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
     */
    public static void clearLogs() {
        File logFile = new File(LOG_FILE);
        if (logFile.exists()) {
            logFile.delete();
        }
        info("Ğ›Ğ¾Ğ³-Ñ„Ğ°Ğ¹Ğ» Ğ¾Ñ‡Ğ¸Ñ‰ĞµĞ½");
    }

    /**
     * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¿ÑƒÑ‚ÑŒ Ğº Ğ»Ğ¾Ğ³-Ñ„Ğ°Ğ¹Ğ»Ñƒ
     */
    public static String getLogFilePath() {
        return new File(LOG_FILE).getAbsolutePath();
    }
}

